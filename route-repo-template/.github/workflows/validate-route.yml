name: Validate Route PR

on:
  pull_request:
    branches: [main]
    paths:
      - 'routes/**'
      - 'waypoints/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed route files
        id: changed
        run: |
          # Get list of added/modified route.json files in this PR
          ROUTE_FILES=$(git diff --name-only --diff-filter=A origin/main...HEAD | grep 'route\.json$' || true)
          echo "route_files=$ROUTE_FILES" >> "$GITHUB_OUTPUT"
          echo "Found route files: $ROUTE_FILES"

      - name: Validate route.json schema
        if: steps.changed.outputs.route_files != ''
        env:
          ROUTE_FILES: ${{ steps.changed.outputs.route_files }}
        run: |
          python3 << 'PYEOF'
          import json, sys, os

          route_files = os.environ.get('ROUTE_FILES', '').strip().split('\n')
          route_files = [f.strip() for f in route_files if f.strip()]

          if not route_files:
              print('No route files to validate')
              sys.exit(0)

          errors = 0
          for filepath in route_files:
              print(f'Validating: {filepath}')

              if not os.path.isfile(filepath):
                  print(f'  ERROR: File not found: {filepath}')
                  errors += 1
                  continue

              try:
                  with open(filepath) as f:
                      data = json.load(f)
              except json.JSONDecodeError as e:
                  print(f'  ERROR: Invalid JSON: {e}')
                  errors += 1
                  continue

              required = ['id', 'version', 'name', 'activityType', 'author', 'createdAt',
                          'region', 'stats', 'boundingBox', 'track']
              missing = [k for k in required if k not in data]
              if missing:
                  print(f'  ERROR: Missing required fields: {missing}')
                  errors += 1
                  continue

              stats_required = ['distanceMeters', 'elevationGainMeters', 'elevationLossMeters', 'durationSeconds']
              missing_stats = [k for k in stats_required if k not in data.get('stats', {})]
              if missing_stats:
                  print(f'  ERROR: Missing stats fields: {missing_stats}')
                  errors += 1
                  continue

              bbox_required = ['north', 'south', 'east', 'west']
              missing_bbox = [k for k in bbox_required if k not in data.get('boundingBox', {})]
              if missing_bbox:
                  print(f'  ERROR: Missing boundingBox fields: {missing_bbox}')
                  errors += 1
                  continue

              min_track_points = 2
              if len(data.get('track', [])) < min_track_points:
                  print(f'  ERROR: Track must have at least {min_track_points} points')
                  errors += 1
                  continue

              valid_types = ['hiking', 'cycling', 'running', 'skiTouring', 'other']
              if data['activityType'] not in valid_types:
                  print(f'  ERROR: Invalid activityType: {data["activityType"]}. Must be one of {valid_types}')
                  errors += 1
                  continue

              print(f'  OK: {data["name"]} by {data["author"]} ({len(data["track"])} track points)')

          if errors > 0:
              print(f'\n{errors} file(s) failed validation')
              sys.exit(1)
          PYEOF

      - name: Check photo file sizes
        run: |
          # Ensure no individual photo exceeds 200KB (compressed 640x400 should be well under)
          MAX_SIZE=204800  # 200KB
          find routes/ waypoints/ -name '*.jpg' -o -name '*.jpeg' -o -name '*.png' 2>/dev/null | while read -r photo; do
            size=$(stat -c%s "$photo" 2>/dev/null || echo 0)
            if [ "$size" -gt "$MAX_SIZE" ]; then
              echo "WARNING: $photo is ${size} bytes (max ${MAX_SIZE})"
            fi
          done
          echo "Photo size check complete"

      - name: Post validation summary
        if: always()
        uses: actions/github-script@v7
        env:
          ROUTE_FILES: ${{ steps.changed.outputs.route_files }}
        with:
          script: |
            const fs = require('fs');
            const routeFiles = (process.env.ROUTE_FILES || '').split('\n').filter(f => f.trim());

            if (routeFiles.length === 0) {
              return;
            }

            let summary = '## Route Validation Summary\n\n';
            for (const file of routeFiles) {
              try {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                const distKm = (data.stats.distanceMeters / 1000).toFixed(1);
                const eleGain = Math.round(data.stats.elevationGainMeters);
                summary += `### ${data.name}\n`;
                summary += `- **Activity:** ${data.activityType}\n`;
                summary += `- **Author:** ${data.author}\n`;
                summary += `- **Region:** ${data.region.area}, ${data.region.country}\n`;
                summary += `- **Distance:** ${distKm} km\n`;
                summary += `- **Elevation Gain:** ${eleGain} m\n`;
                summary += `- **Track Points:** ${data.track.length}\n`;
                summary += `- **Waypoints:** ${(data.waypoints || []).length}\n`;
                summary += `- **Photos:** ${(data.photos || []).length}\n\n`;
              } catch (e) {
                summary += `- **${file}:** Failed to parse - ${e.message}\n\n`;
              }
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
